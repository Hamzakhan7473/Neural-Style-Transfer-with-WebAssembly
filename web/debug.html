<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug - Neural Style Transfer</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }

        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }

        .success {
            background: #d4edda;
            color: #155724;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
        }

        .warning {
            background: #fff3cd;
            color: #856404;
        }

        button {
            padding: 10px 20px;
            margin: 5px;
        }

        #log {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
        }
    </style>
</head>

<body>
    <h1>üîç Neural Style Transfer Debug</h1>

    <div id="status" class="status warning">Initializing...</div>

    <div>
        <button onclick="testWasm()">Test WASM</button>
        <button onclick="testOnnx()">Test ONNX Runtime</button>
        <button onclick="testModel()">Test Model Download</button>
        <button onclick="clearLog()">Clear Log</button>
    </div>

    <div id="log"></div>

    <script type="module">
        let logElement = document.getElementById('log');
        let statusElement = document.getElementById('status');

        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            logElement.textContent += `[${timestamp}] ${message}\n`;
            console.log(message);
        }

        function updateStatus(message, type = 'warning') {
            statusElement.textContent = message;
            statusElement.className = `status ${type}`;
        }

        window.testWasm = async function () {
            try {
                log('Testing WASM module...');
                const wasmModule = await import('./pkg/neural_style_transfer.js');
                log('WASM module imported successfully');
                log('Available exports:', Object.keys(wasmModule));

                // Check if default export exists
                if (!wasmModule.default) {
                    throw new Error('Default export not found. Available exports: ' + Object.keys(wasmModule).join(', '));
                }

                const init = wasmModule.default; // Default export is the init function
                log('Calling init function...');
                await init();
                log('WASM module initialized');

                wasmModule.init_panic_hook();
                log('Panic hook set');

                updateStatus('WASM module working!', 'success');
            } catch (error) {
                log(`WASM error: ${error.message}`);
                log(`Error stack: ${error.stack}`);
                updateStatus('WASM failed', 'error');
            }
        };

        window.testOnnx = async function () {
            try {
                log('Testing ONNX Runtime...');

                // Load ONNX Runtime
                if (typeof window.ort === 'undefined') {
                    log('Loading ONNX Runtime from CDN...');
                    await new Promise((resolve, reject) => {
                        const script = document.createElement('script');
                        script.src = 'https://cdn.jsdelivr.net/npm/onnxruntime-web@1.19.0/dist/ort.webgpu.min.js';
                        script.onload = resolve;
                        script.onerror = reject;
                        document.head.appendChild(script);
                    });
                    log('ONNX Runtime loaded from CDN');
                }

                log('ONNX Runtime available');
                log(`ONNX Runtime version: ${window.ort?.env?.wasm?.numThreads || 'unknown'}`);

                updateStatus('ONNX Runtime working!', 'success');
            } catch (error) {
                log(`ONNX Runtime error: ${error.message}`);
                updateStatus('ONNX Runtime failed', 'error');
            }
        };

        window.testModel = async function () {
            try {
                log('Testing model download...');
                const response = await fetch('./models/mosaic-9.onnx');
                if (response.ok) {
                    const size = response.headers.get('content-length');
                    log(`Model download successful: ${size} bytes`);
                    updateStatus('Model download working!', 'success');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                log(`Model download error: ${error.message}`);
                updateStatus('Model download failed', 'error');
            }
        };

        window.clearLog = function () {
            logElement.textContent = '';
        };

        // Auto-run tests
        log('Debug page loaded');
        updateStatus('Ready for testing', 'success');
    </script>
</body>

</html>